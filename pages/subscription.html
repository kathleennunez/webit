<?php include __DIR__ . '/../components/header.php'; ?>
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h4 fw-bold">Subscription</h1>
      <p class="text-muted">Choose a plan to unlock premium webinar creation.</p>
    </div>
  </div>

  <div class="glass-panel p-4">
    <?php if (!empty($paymentNotice)): ?>
      <div class="alert alert-success d-flex justify-content-between align-items-center gap-2">
        <div>Payment received. Your subscription is now active.</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <?php endif; ?>
    <?php if (!empty($subscription) && ($subscription['status'] ?? '') === 'active'): ?>
      <div class="alert alert-success d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          Active plan: <strong><?php echo sanitize(ucfirst($subscription['plan'] ?? 'monthly')); ?></strong>
          <?php if (!empty($subscription['renewal_at'])): ?>
            <span class="text-muted">Â· Renews <?php echo sanitize(format_datetime_for_user($subscription['renewal_at'], $user['timezone'] ?? null)); ?></span>
          <?php endif; ?>
        </div>
        <span class="badge-soft">Subscribed</span>
      </div>
    <?php endif; ?>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="plan-card h-100">
          <h6 class="fw-bold">Monthly</h6>
          <div class="display-6 fw-bold mb-2">$19</div>
          <p class="text-muted small mb-3">Unlock premium webinar publishing with custom pricing.</p>
          <ul class="text-muted small mb-4">
            <li>Create premium sessions</li>
            <li>Set your own prices</li>
            <li>Host recurring series</li>
          </ul>
          <?php if (!empty($subscription) && ($subscription['status'] ?? '') === 'active' && ($subscription['plan'] ?? '') === 'monthly'): ?>
            <div class="badge-soft">Current plan</div>
          <?php else: ?>
            <div id="paypal-subscribe-monthly"></div>
          <?php endif; ?>
        </div>
      </div>
      <div class="col-md-6">
        <div class="plan-card h-100">
          <h6 class="fw-bold">Yearly</h6>
          <div class="display-6 fw-bold mb-2">$180</div>
          <p class="text-muted small mb-3">Save 20% and keep premium hosting active all year.</p>
          <ul class="text-muted small mb-4">
            <li>Everything in Monthly</li>
            <li>Priority support</li>
            <li>Early feature access</li>
          </ul>
          <?php if (!empty($subscription) && ($subscription['status'] ?? '') === 'active' && ($subscription['plan'] ?? '') === 'yearly'): ?>
            <div class="badge-soft">Current plan</div>
          <?php else: ?>
            <div id="paypal-subscribe-yearly"></div>
          <?php endif; ?>
        </div>
      </div>
    </div>
  </div>
</div>
<?php if (empty($subscription) || ($subscription['status'] ?? '') !== 'active'): ?>
  <?php if (!empty($paypalClientId)): ?>
    <script src="https://www.paypal.com/sdk/js?client-id=<?php echo sanitize($paypalClientId); ?>&currency=USD"></script>
  <?php endif; ?>
  <script>
    if (!window.paypal) {
      console.warn('PayPal SDK missing or client id not configured.');
    }
    const renderSubscription = (containerId, amount, plan) => {
      if (!window.paypal) {
        return;
      }
      window.paypal.Buttons({
        createOrder: () => fetch('/paypal-integration/create-order.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'subscription', plan })
        }).then((res) => res.json()).then((data) => data.id),
        onApprove: (data) => {
          return fetch('/paypal-integration/capture-order.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_id: data.orderID, type: 'subscription' })
          }).then((res) => res.json()).then((payload) => {
            if (!payload || payload.error) {
              alert(payload?.error || 'Payment failed. Please try again.');
              return;
            }
            window.location = '/app/subscription.php?paid=1';
          });
        }
      }).render(containerId);
    };

    renderSubscription('#paypal-subscribe-monthly', '19.00', 'monthly');
    renderSubscription('#paypal-subscribe-yearly', '180.00', 'yearly');
  </script>
<?php endif; ?>
</main>
  <?php if (current_user()): ?>
    </div>
  <?php endif; ?>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/app.js"></script>
</body>
</html>
