<?php include __DIR__ . '/../components/header.php'; ?>
<div class="container py-5">
  <div class="mb-3">
    <a class="btn btn-outline-primary btn-sm" href="/home.php"><i class="bi bi-arrow-left me-2"></i>Back to Browse</a>
  </div>
  <div class="glass-panel p-4 mb-4">
    <img src="<?php echo sanitize($webinar['image'] ?? '/assets/images/webinar-education.svg'); ?>" class="w-100 rounded-4 mb-4" alt="Webinar preview">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <span class="badge-soft mb-2 d-inline-block"><?php echo sanitize($webinar['category']); ?></span>
        <h1 class="h3 fw-bold mb-2"><?php echo sanitize($webinar['title']); ?></h1>
        <div class="d-flex align-items-center gap-2 text-muted">
          <img src="<?php echo sanitize(avatar_url($hostUser)); ?>" class="avatar-sm" alt="Host">
          <a class="text-decoration-none text-muted" href="/account.php?user_id=<?php echo sanitize($hostUser['id'] ?? ''); ?>">
            Hosted by <?php echo sanitize($webinar['instructor']); ?>
          </a>
        </div>
      </div>
      <?php if ($webinar['premium'] ?? false): ?>
        <span class="badge bg-warning text-dark">Premium</span>
      <?php endif; ?>
    </div>
    <?php if ($message): ?>
      <div class="alert alert-success mt-3"><?php echo sanitize($message); ?></div>
    <?php endif; ?>
    <?php if ($error): ?>
      <div class="alert alert-danger mt-3"><?php echo sanitize($error); ?></div>
    <?php endif; ?>
    <p class="mt-3"><?php echo sanitize($webinar['description']); ?></p>
    <div class="row mt-4">
      <div class="col-md-6">
        <p class="mb-1 text-muted">Date & Time</p>
        <p><i class="bi bi-calendar-event me-2"></i><?php echo sanitize($displayDatetime); ?></p>
      </div>
      <div class="col-md-6">
        <p class="mb-1 text-muted">Duration</p>
        <p><i class="bi bi-clock me-2"></i><?php echo sanitize($webinar['duration']); ?></p>
      </div>
    </div>
    <?php if ($isPremium): ?>
      <div class="mt-3">
        <p class="mb-1 text-muted">Price</p>
        <p><i class="bi bi-tag me-2"></i>$<?php echo sanitize(number_format((float)$price, 2)); ?></p>
        <?php if ($hasPaid): ?>
          <div class="badge-soft mt-2">Payment received</div>
        <?php endif; ?>
      </div>
    <?php endif; ?>
    <div class="mt-4">
      <?php if ($isPremium && !$hasPaid): ?>
        <button type="button" class="btn btn-primary">Pay with PayPal</button>
      <?php elseif ($canRegister): ?>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
          <?php echo sanitize($registerLabel); ?>
        </button>
      <?php else: ?>
        <button type="button" class="btn btn-outline-secondary" disabled>
          <?php echo sanitize($registerLabel); ?>
        </button>
      <?php endif; ?>
    </div>
    <?php if ((!$canRegister || $isPremium) && $registerHint): ?>
      <div class="text-muted small mt-2"><?php echo sanitize($registerHint); ?></div>
    <?php endif; ?>
    <?php if (!empty($webinar['meeting_url'])): ?>
      <div class="mt-3">
        <a class="btn btn-outline-primary" href="<?php echo sanitize($webinar['meeting_url']); ?>" target="_blank" rel="noopener">
          Join session
        </a>
      </div>
    <?php endif; ?>
  </div>
</div>

<?php if (!$locked && $canRegister): ?>
  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content glass-panel">
        <div class="modal-header border-0">
          <h5 class="modal-title">Confirm registration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post">
          <div class="modal-body">
            <div class="mb-3">
              <div class="fw-semibold"><?php echo sanitize($webinar['title']); ?></div>
              <div class="text-muted small"><?php echo sanitize($displayDatetime); ?> â€¢ <?php echo sanitize($webinar['duration']); ?></div>
            </div>
            <div class="mb-3">
              <div class="fw-semibold mb-2">Checklist</div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="agreePolicy" required>
                <label class="form-check-label" for="agreePolicy">I agree to the session policy</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="agreeNotify" required>
                <label class="form-check-label" for="agreeNotify">Send me reminders before the webinar</label>
              </div>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Cancel</button>
            <input type="hidden" name="register" value="1">
            <button type="submit" class="btn btn-primary" data-register-btn>
              Confirm Registration
              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
<?php endif; ?>
<?php include __DIR__ . '/../components/footer.php'; ?>
